name: CI / Test / Build & Publish (GHCR)

on:
  push:
    branches: [ 'replit-agent', 'main' ]

permissions:
  contents: read
  packages: write
  pages: write
  id-token: write
  actions: read

# Define the original image name, we'll convert it to lowercase in the steps
env:
  IMAGE_NAME_ORIG: ${{ github.event.repository.name }}

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Run tests
        run: npx vitest run src/__tests__/ci-workflows.test.ts

  build-and-push:
    name: Build & push Docker images to GHCR
    runs-on: ubuntu-latest
    needs: test
    if: github.repository_owner == 'backerjr' && github.event_name == 'push'
    outputs:
      repo_owner_lower: ${{ steps.lowercase_owner.outputs.repository_owner }}
      repo_name_lower: ${{ steps.lowercase_repo.outputs.repository_name }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install deps & Build
        run: |
          npm ci
          npm run build
      
      - name: Convert repository owner to lowercase
        id: lowercase_owner
        run: |
          echo "repository_owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Convert repository name to lowercase
        id: lowercase_repo
        run: |
          echo "repository_name=$(echo ${{ env.IMAGE_NAME_ORIG }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push nginx image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.nginx
          push: true
          platforms: linux/amd64
          tags: |
            ghcr.io/${{ steps.lowercase_owner.outputs.repository_owner }}/${{ steps.lowercase_repo.outputs.repository_name }}:nginx-latest
            ghcr.io/${{ steps.lowercase_owner.outputs.repository_owner }}/${{ steps.lowercase_repo.outputs.repository_name }}:nginx-${{ github.sha }}

      - name: Build and push caddy image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.caddy
          push: true
          platforms: linux/amd64
          tags: |
            ghcr.io/${{ steps.lowercase_owner.outputs.repository_owner }}/${{ steps.lowercase_repo.outputs.repository_name }}:caddy-latest
            ghcr.io/${{ steps.lowercase_owner.outputs.repository_owner }}/${{ steps.lowercase_repo.outputs.repository_name }}:caddy-${{ github.sha }}

  test-images:
    name: Pull and smoke-test pushed images (nginx & caddy)
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.repository_owner == 'backerjr' && github.event_name == 'push'
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run nginx image
        env:
          IMAGE_NGINX: ghcr.io/${{ needs.build-and-push.outputs.repo_owner_lower }}/${{ needs.build-and-push.outputs.repo_name_lower }}:nginx-latest
        run: |
          docker pull "$IMAGE_NGINX"
          docker run -d --name waapp-nginx-ci -p 8080:80 "$IMAGE_NGINX"

          # Retry until nginx responds (30 attempts, 2s apart)
          for i in {1..30}; do
            if curl --fail --silent --show-error http://localhost:8080; then
              echo "nginx is ready"
              break
            fi
            echo "Waiting for nginx to be ready... ($i/30)"
            sleep 2
          done

          # If still not ready, print a helpful message and exit non-zero
          if ! curl --fail --silent http://localhost:8080; then
            echo "ERROR: nginx did not respond on http://localhost:8080" >&2
            docker logs waapp-nginx-ci || true
            docker rm -f waapp-nginx-ci || true
            exit 1
          fi

          docker logs waapp-nginx-ci || true
          docker rm -f waapp-nginx-ci || true

      - name: Pull and run caddy image
        env:
          IMAGE_CADDY: ghcr.io/${{ needs.build-and-push.outputs.repo_owner_lower }}/${{ needs.build-and-push.outputs.repo_name_lower }}:caddy-latest
        run: |
          docker pull "$IMAGE_CADDY"
          docker run -d --name waapp-caddy-ci -p 8081:80 "$IMAGE_CADDY"
          curl --retry 10 --retry-delay 1 --retry-connrefused http://localhost:8081
          docker logs waapp-caddy-ci || true
          docker rm -f waapp-caddy-ci || true

  make-ghcr-public:
    name: Attempt to make GHCR package public
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always() && github.repository_owner == 'backerjr'
    steps:
      - name: Try to set package visibility
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const pkg = '${{ needs.build-and-push.outputs.repo_name_lower }}';
            try {
              await github.rest.packages.setAccessibilityForPackageOwnedByUser({
                package_type: 'container',
                package_name: pkg,
                username: owner,
                visibility: 'public'
              });
              core.info(`Set user package visibility for '${pkg}' to public`);
            } catch (e) {
              core.warning(`Failed to set user package visibility: ${e.message}`);
              core.warning('This may be expected if the repository is owned by an organization.');
            }
