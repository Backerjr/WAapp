- name: Pull and run nginx image
  env:
    IMAGE_NGINX: ghcr.io/${{ needs.build-and-push.outputs.repo_owner_lower }}/${{ needs.build-and-push.outputs.repo_name_lower }}:nginx-latest
  run: |
    docker pull "$IMAGE_NGINX"
    docker run -d --name waapp-nginx-ci -p 8080:80 "$IMAGE_NGINX"

    # Retry until nginx responds (30 attempts, 2s apart)
    for i in {1..30}; do
      if curl --fail --silent --show-error http://localhost:8080; then
        echo "nginx is ready"
        break
      fi
      echo "Waiting for nginx to be ready... ($i/30)"
      sleep 2
    done

    # Show logs and clean up (keep failures non-fatal for diagnostics)
    docker logs waapp-nginx-ci || true
    docker rm -f waapp-nginx-ci || true
